name: Publish release

on:
    workflow_dispatch:
    release:
        types: [created]

jobs:
    build:
        name: Build files
        runs-on: self-hosted

        steps:
            - uses: actions/checkout@v3
            - name: Use Node.js 16
              uses: actions/setup-node@v3
              with:
                  node-version: 16
                  cache: 'npm'
            - name: Install npm packages
              run: npm install
            - name: Test with vitest
              run: npm test
            - name: Build with Vite
              run: npm run build

    publish:
        name: Publish release
        runs-on: self-hosted

        needs: build
        permissions:
            contents: read
            deployments: write

        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-node@v3
              with:
                  node-version: 16
                  cache: 'npm'
            - name: Sign Firefox
              run: npm run sign -- --api-secret ${{secrets.FIREFOX_TOKEN}}
